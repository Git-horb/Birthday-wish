<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday Emily üéâ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÇ</text></svg>">
<style>
  :root{
    --bg:#070812;
    --card:#0f1724;
    --accent1:#ff6fb5;
    --accent2:#9b7cff;
    --gold:#ffd27f;
    --glass: rgba(255,255,255,0.03);
    --text:#eaf2ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(900px 400px at 10% 10%, rgba(155,124,255,0.06), transparent 8%),
      radial-gradient(700px 300px at 90% 85%, rgba(255,111,181,0.04), transparent 12%),
      var(--bg);
    color:var(--text);
    display:flex; align-items:center; justify-content:center; padding:28px;
  }

  .wrap{
    width:100%; max-width:980px; border-radius:18px; background:linear-gradient(180deg,var(--glass), transparent);
    padding:26px; box-shadow: 0 14px 50px rgba(1,4,20,0.7); position:relative; overflow:hidden;
    border:1px solid rgba(255,255,255,0.03);
  }

  header{display:flex; gap:12px; align-items:center; margin-bottom:16px}
  .logo{
    width:64px; height:64px; border-radius:12px; display:grid; place-items:center; font-size:28px;
    background: linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 8px 30px rgba(155,124,255,0.12);
  }
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:rgba(234,242,255,0.8);font-size:14px}

  .main{display:grid; grid-template-columns: 1fr 340px; gap:22px; align-items:start}
  @media (max-width:920px){ .main{grid-template-columns:1fr} .side{order:2} }

  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); border-radius:14px; padding:18px; border:1px solid rgba(255,255,255,0.02); position:relative; overflow:hidden}

  .countdown{display:flex; gap:10px; justify-content:center; align-items:center; padding:18px 10px}
  .timebox{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); padding:16px 12px; text-align:center; border-radius:12px; min-width:72px; box-shadow: inset 0 -2px 6px rgba(0,0,0,0.25)}
  .timebox strong{display:block; font-size:28px}
  .timebox small{color:rgba(234,242,255,0.68); display:block; margin-top:6px; font-size:12px}

  .big-note{font-size:20px; text-align:center; margin:8px 0 14px; color:var(--gold); font-weight:600}

  .controls{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
  button{
    padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:700;
    background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#070812;
    box-shadow: 0 8px 30px rgba(155,124,255,0.08);
  }
  .btn-ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04); box-shadow:none}

  .side .card-title{display:flex; align-items:center; gap:10px; margin-bottom:10px}
  .wish-list{display:grid; gap:10px; max-height:460px; overflow:auto; padding-right:6px}

  .wish{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.02)}
  .quote{font-style:italic; color:rgba(234,242,255,0.78)}

  .celebrate{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
    background: radial-gradient(700px 420px at 50% 20%, rgba(155,124,255,0.06), transparent 20%);
    z-index:20; opacity:0; pointer-events:none; transform:scale(1.02); transition:all 600ms cubic-bezier(.16,.8,.4,1); padding:28px;
  }
  .celebrate.show{opacity:1; pointer-events:auto; transform:scale(1);}

  .confetti-canvas{position:absolute; inset:0; pointer-events:none; z-index:22}
  .sparkles{position:absolute; inset:0; pointer-events:none; z-index:23}
  .glow-text{font-size:34px; font-weight:800; text-align:center; letter-spacing:0.6px; text-shadow:0 10px 40px rgba(155,124,255,0.14); margin-top:10px}

  .cake{width:260px; height:220px; border-radius:18px; background:linear-gradient(180deg,#fff,#ffeef6); display:flex; align-items:center; justify-content:center; box-shadow:0 12px 40px rgba(0,0,0,0.35); position:relative}
  .flame{position:absolute; top:-34px; left:50%; transform:translateX(-50%); width:28px; height:56px; display:grid; place-items:center}
  .candles{display:flex; gap:8px}
  .candle{width:8px; height:36px; background:linear-gradient(180deg,#ffd7a6,#ff9b6a); border-radius:6px; position:relative; box-shadow:0 4px 12px rgba(0,0,0,0.25)}
  .flicker{position:absolute; top:-22px; left:50%; transform:translateX(-50%); font-size:18px; filter:drop-shadow(0 4px 6px rgba(255,140,0,0.5)); animation:flick 900ms infinite}
  @keyframes flick{0%{opacity:0.6; transform:translateX(-50%) scale(0.92)}50%{opacity:1; transform:translateX(-50%) scale(1.08)}100%{opacity:0.7; transform:translateX(-50%) scale(0.95)}}

  .floaters{position:absolute; inset:0; pointer-events:none; z-index:12}
  .floater{position:absolute; width:28px; height:28px; opacity:0.9; transform-origin:center; animation:floatUp linear infinite}
  .floater.heart::before{content:"‚ù§"; display:block; font-size:22px; transform:rotate(-15deg)}
  .floater.star::before{content:"‚ú¶"; display:block; font-size:18px; transform:rotate(8deg)}
  @keyframes floatUp{0%{transform:translateY(10vh) scale(0.9) rotate(0)}100%{transform:translateY(-100vh) scale(1.05) rotate(360deg)}}

  footer{margin-top:12px; text-align:center; color:rgba(234,242,255,0.45); font-size:13px}
  .muted{color:rgba(234,242,255,0.58); font-size:13px}
  .center{display:flex; gap:8px; justify-content:center; align-items:center}
</style>
</head>
<body>
  <div class="wrap" role="main" aria-live="polite">
    <header>
      <div class="logo">EM</div>
      <div>
        <h1>For Emily ‚Äî A Tiny Birthday Surprise</h1>
        <p class="lead">Countdown to Nov 7 ‚Ä¢ Cambodia time (Asia/Phnom_Penh, UTC+7)</p>
      </div>
    </header>

    <div class="main">
      <section class="panel" aria-label="Main countdown and celebration area">
        <div id="countdown-view">
          <div class="big-note" id="countdown-note">Counting down to Nov 7</div>
          <div class="countdown" aria-hidden="false">
            <div class="timebox"><strong id="days">0</strong><small>days</small></div>
            <div class="timebox"><strong id="hours">00</strong><small>hours</small></div>
            <div class="timebox"><strong id="minutes">00</strong><small>minutes</small></div>
            <div class="timebox"><strong id="seconds">00</strong><small>seconds</small></div>
          </div>

          <div class="controls" style="margin-top:12px">
            <button id="singBtn" title="Sing Happy Birthday to Emily">üé§ Sing for Emily</button>
            <button id="musicBtn" class="btn-ghost" title="Toggle simple melody">‚ô™ Melody: Off</button>
            <button id="replayBtn" class="btn-ghost" title="Force the celebration now">‚ú® Celebrate now</button>
            <button id="shareBtn" class="btn-ghost" title="Share link">Share</button>
          </div>

          <p class="muted center" style="margin-top:12px">Tip: for autoplay audio on the birthday, allow site audio / press "Sing" if the browser blocks autoplay.</p>
        </div>

        <!-- Birthday view -->
        <div class="celebrate" id="birthday-screen" aria-hidden="true">
          <canvas class="confetti-canvas" id="confetti"></canvas>
          <div class="sparkles" id="sparkles"></div>

          <div style="display:flex; gap:18px; align-items:center; flex-direction:column; z-index:30;">
            <div class="glow-text">Happy Birthday, Emily üéâ</div>

            <div class="cake" role="img" aria-label="Birthday cake with candles">
              <div class="flame"><div class="flicker">üî•</div></div>
              <div style="text-align:center">
                <div class="candles" aria-hidden="true"><div class="candle"></div><div class="candle"></div><div class="candle"></div></div>
                <div style="margin-top:12px; font-weight:700; color:#6b2a4a">Make a wish ‚ú®</div>
              </div>
            </div>

            <div id="messages" style="max-width:820px; text-align:center; z-index:31; color:var(--text)"></div>

            <div style="display:flex; gap:10px; margin-top:8px; z-index:31;">
              <button id="replayCelebrate" class="btn-ghost">Replay</button>
              <button id="closeCelebrate" class="btn-ghost">Close</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="side panel" aria-label="Wishes and extras">
        <div class="card-title">
          <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:grid;place-items:center;font-weight:800">üíñ</div>
          <div>
            <div style="font-weight:700">Notes & Wishes</div>
            <div class="muted">Personal messages & gentle quotes (prewritten)</div>
          </div>
        </div>

        <div class="wish-list" id="wishList">
          <!-- curated wishes (prepopulated) -->
          <div class="wish">
            <div style="font-weight:700">A message just for Emily</div>
            <div style="margin-top:6px">Emily ‚Äî on your day I wish you mornings that glow like jasmine, laughter that rises easy, and the kind of gentle surprises that make your heart skip. You are cherished more than you know.</div>
          </div>

          <div class="wish">
            <div style="font-weight:700">A note from a friend</div>
            <div style="margin-top:6px">Today I celebrate the way you make small moments feel like home. Thank you for being kind, bright, and real. May every new year bring you closer to the dreams you whisper to yourself at night.</div>
          </div>

          <div class="wish quote">"Friendship is the single soul dwelling in two bodies." ‚Äî Aristotle</div>

          <div class="wish">
            <div style="font-weight:700">Short & sweet</div>
            <div style="margin-top:6px">You matter. You are loved. Keep shining, Emily.</div>
          </div>

          <div class="wish quote">"May your choices reflect your hopes, not your fears." ‚Äî Nelson Mandela</div>

          <div class="wish">
            <div style="font-weight:700">Final little wish</div>
            <div style="margin-top:6px">If I could give you one thing today it would be a pocketful of unexpected joy and a map of new wonders to discover.</div>
          </div>
        </div>

        <div style="margin-top:14px; display:flex; gap:8px; justify-content:center">
          <button id="downloadBtn" class="btn-ghost">Download page</button>
          <button id="openBtn" class="btn-ghost">Open in new tab</button>
        </div>

        <div style="margin-top:14px; text-align:center" class="muted">
          <div>Replace the sample image and audio with your CDN links in the script below.</div>
        </div>
      </aside>
    </div>

    <footer>Made with care ‚Ä¢ Messages written for Emily ‚Äî tweak freely if you wish üíå</footer>

    <div class="floaters" id="floaters"></div>
  </div>

<!-- ---------- Config (replace with your CDN links) ---------- -->
<script>
/* ---------- USER REPLACEABLE ---------- */
const SAMPLE_AUDIO_URL = 'https://cdn.example.com/emily-happy-birthday.mp3'; // <- replace with your song link (CDN)
const SAMPLE_IMAGE_URL = 'https://cdn.example.com/emily-photo1.jpg'; // <- replace image (optional slideshow) 
/* ---------- END USER REPLACEABLE ---------- */

/* ---------- Timezone / target date calculation (Asia/Phnom_Penh, UTC+7) ---------- */
/*
  We construct the exact UTC timestamp that corresponds to Nov 7, 00:00:00 in Cambodia (UTC+7).
  This ensures the countdown triggers exactly when Cambodia hits midnight.
*/
const TARGET_MONTH = 10; // November (0-indexed)
const TARGET_DAY = 7;
const khTimeOffsetHours = 7; // UTC+7

function getTargetUTCForYear(year){
  // Construct UTC ms for (year, TARGET_MONTH, TARGET_DAY, 00:00) in UTC+7 by subtracting 7 hours.
  // Date.UTC accepts hours outside 0-23 range; this is intentional to shift by -7.
  return Date.UTC(year, TARGET_MONTH, TARGET_DAY, -khTimeOffsetHours, 0, 0, 0);
}

// Decide which year to target based on Cambodia "now"
function nowInUTC(){ return Date.now(); }
function nowInKHDate(){
  // Use Intl to get the current parts in Asia/Phnom_Penh ‚Äî then build a Date from those parts local to KH.
  const parts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Asia/Phnom_Penh',
    year:'numeric', month:'numeric', day:'numeric', hour:'numeric', minute:'numeric', second:'numeric'
  }).formatToParts(new Date());
  const p = {};
  parts.forEach(x => p[x.type] = x.value);
  // month in JS Date is 1-based in these parts, convert to 0-based:
  return new Date(p.year, Number(p.month)-1, p.day, p.hour, p.minute, p.second);
}

// Determine correct target year (use KH local "today" to decide)
const khNow = nowInKHDate();
let targetYear = khNow.getFullYear();
let targetUTC = getTargetUTCForYear(targetYear);
if (Date.now() >= targetUTC) { targetYear = targetYear + 1; targetUTC = getTargetUTCForYear(targetYear); }

const targetDate = new Date(targetUTC); // exact UTC moment for Nov 7 00:00 Asia/Phnom_Penh

/* ---------- Countdown UI ---------- */
const elDays = document.getElementById('days');
const elHours = document.getElementById('hours');
const elMinutes = document.getElementById('minutes');
const elSeconds = document.getElementById('seconds');
const note = document.getElementById('countdown-note');
const birthdayScreen = document.getElementById('birthday-screen');
const messagesEl = document.getElementById('messages');

function updateCountdown(){
  const now = Date.now();
  const diff = targetDate.getTime() - now;
  if (diff <= 0){
    elDays.textContent = '0';
    elHours.textContent = '00';
    elMinutes.textContent = '00';
    elSeconds.textContent = '00';
    note.textContent = `It's here ‚Äî Happy Birthday Emily! (Cambodia time)`;
    triggerCelebration();
    return;
  }
  const s = Math.floor(diff/1000);
  const days = Math.floor(s/86400);
  const hours = Math.floor((s%86400)/3600);
  const minutes = Math.floor((s%3600)/60);
  const seconds = s%60;
  elDays.textContent = String(days);
  elHours.textContent = String(hours).padStart(2,'0');
  elMinutes.textContent = String(minutes).padStart(2,'0');
  elSeconds.textContent = String(seconds).padStart(2,'0');

  // Display explicit target label in Cambodia timezone
  const label = new Intl.DateTimeFormat(undefined, { timeZone:'Asia/Phnom_Penh', weekday:'long', year:'numeric', month:'long', day:'numeric' }).format(targetDate);
  note.textContent = `Counting down to ${label} (Cambodia time) ‚Ä¢ ${days} days left`;
}
updateCountdown();
const timerInterval = setInterval(updateCountdown, 1000);

/* ---------- Floaters ---------- */
const floaters = document.getElementById('floaters');
function spawnFloaters(){
  const count = 10;
  for(let i=0;i<count;i++){
    const el = document.createElement('div');
    el.className = 'floater ' + (Math.random()>0.65 ? 'star' : 'heart');
    el.style.left = Math.random()*100 + '%';
    el.style.top = (80 + Math.random()*18) + '%';
    el.style.fontSize = (12+Math.random()*26)+'px';
    el.style.animationDuration = (10+Math.random()*20)+'s';
    el.style.opacity = (0.45 + Math.random()*0.9);
    floaters.appendChild(el);
    setTimeout(()=>el.remove(), 32000);
  }
}
spawnFloaters();
setInterval(spawnFloaters, 15000);

/* ---------- Messages for the birthday scene (multiple emotional paragraphs) ---------- */
const celebrationMessages = [
  "<strong>Happy Birthday, Emily.</strong> Today is a quiet promise ‚Äî that the small things you do, the kindness you give, and the softness you bring into someone's day will bloom into something unforgettable.",
  "On this day I wish for you mornings that smell like rain-washed jasmine, laughter that arrives easily, and the courage that follows gentle curiosity. May the year ahead hold doors you already dream about.",
  "You have a way of turning ordinary moments into warm memories. Thank you for being genuine, bright, and quietly brave. I hope you feel how much you are treasured today and always.",
  "May your path be steady and lined with people who see you, understand you, and celebrate the small victories with you. If ever you doubt, remember there are hands ‚Äî and hearts ‚Äî that will hold you steady.",
  "<em>‚Äî with a warm, shy hope that this day brings you the tiniest, sweetest surprises you weren't expecting</em>"
];

/* ---------- Celebration visuals & audio ---------- */
let confettiTimer;
function triggerCelebration(){
  // stop countdown
  clearInterval(timerInterval);

  // fill messages
  messagesEl.innerHTML = celebrationMessages.map(m => `<div style="margin:10px 0; font-size:15px; line-height:1.45">${m}</div>`).join('');

  // show UI
  birthdayScreen.classList.add('show');
  birthdayScreen.setAttribute('aria-hidden','false');

  // visuals
  startConfetti();
  createSparkles();

  // try to autoplay audio (browsers might block ‚Äî user interaction recommended)
  playBirthdayAudio();

  // small gentle flash of floaters
  spawnFloaters();
}

/* ---------- Confetti ---------- */
function startConfetti(){
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  function resize(){
    canvas.width = window.innerWidth * 1.4;
    canvas.height = window.innerHeight * 1.1;
  }
  resize();
  window.addEventListener('resize', resize);
  const W = canvas.width, H = canvas.height;
  const pieces = [];
  const colors=['#ff6fb5','#ffd27f','#9b7cff','#66e0ff','#fff4cc'];
  for(let i=0;i<220;i++){
    pieces.push({
      x: Math.random()*W,
      y: Math.random()*H - H,
      r: 6+Math.random()*12,
      d: Math.random()*60 + 10,
      color: colors[Math.floor(Math.random()*colors.length)],
      tilt: Math.random()*20 - 10,
      tiltAngleIncremental: (Math.random()*0.07)+0.03,
      tiltAngle:0
    });
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p=>{
      p.tiltAngle += p.tiltAngleIncremental;
      p.y += (Math.cos(p.d) + 3 + p.r/2);
      p.x += Math.sin(p.tiltAngle) * 0.5;
      p.tilt = Math.sin(p.tiltAngle - (p.d/50)) * 12;
      ctx.beginPath();
      ctx.lineWidth = p.r;
      ctx.strokeStyle = p.color;
      ctx.moveTo(p.x + p.tilt + p.r/2, p.y);
      ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r/2);
      ctx.stroke();
      if (p.y > canvas.height + 100) { p.y = -50; p.x = Math.random()*canvas.width; }
    });
    confettiTimer = requestAnimationFrame(draw);
  }
  draw();
  // stop auto after 20s
  setTimeout(()=>{ cancelAnimationFrame(confettiTimer); ctx.clearRect(0,0,canvas.width,canvas.height); }, 20000);
}

/* ---------- Sparkles overlay ---------- */
function createSparkles(){
  const s = document.getElementById('sparkles');
  s.innerHTML = '';
  const count = 44;
  for(let i=0;i<count;i++){
    const span = document.createElement('div');
    span.style.position='absolute';
    span.style.left = Math.random()*90 + '%';
    span.style.top = Math.random()*70 + '%';
    span.style.fontSize = (8+Math.random()*26)+'px';
    span.style.opacity = 0.95;
    span.textContent = Math.random()>0.6 ? '‚ú¶' : '‚ú∂';
    span.style.transform = `rotate(${Math.random()*360}deg)`;
    span.style.filter = 'drop-shadow(0 6px 20px rgba(155,124,255,0.12))';
    s.appendChild(span);
    span.animate([{opacity:0.2},{opacity:1},{opacity:0.4}], {duration: 2000 + Math.random()*3000, iterations: Infinity, delay: Math.random()*1200});
  }
}

/* ---------- Audio: Speech + Song ---------- */
let audioEl;
function ensureAudioEl(){
  if (!audioEl){
    audioEl = document.createElement('audio');
    audioEl.src = SAMPLE_AUDIO_URL;
    audioEl.preload = 'auto';
    audioEl.controls = false;
    audioEl.loop = false;
    audioEl.style.display = 'none';
    document.body.appendChild(audioEl);
  }
}
async function playBirthdayAudio(){
  ensureAudioEl();
  try{
    // Attempt to play the provided MP3 (CDN). Many browsers will block autoplay unless interacted with.
    await audioEl.play();
  }catch(err){
    // If play is blocked, do nothing (user can press Sing)
    console.warn('Autoplay blocked or failed:', err);
  }
}

/* ---------- Sing using SpeechSynthesis + short melody fallback ---------- */
const singBtn = document.getElementById('singBtn');
let audioCtx = null, melodyOn = false;

function speakHappyBirthday(){
  if (!('speechSynthesis' in window)) {
    alert('Speech synthesis not supported in this browser. The uploaded audio will still play if you press "Sing".');
    return;
  }
  const s = window.speechSynthesis;
  s.cancel();
  const lines = [
    {text:'Happy birthday to you', pitch:1.05, rate:0.95},
    {text:'Happy birthday to you', pitch:1.05, rate:0.95},
    {text:`Happy birthday dear Emily`, pitch:1.12, rate:0.92},
    {text:'Happy birthday to you', pitch:1.02, rate:0.9}
  ];
  let i=0;
  function speakNext(){
    if (i>=lines.length) { return; }
    const u = new SpeechSynthesisUtterance(lines[i].text);
    u.pitch = lines[i].pitch; u.rate = lines[i].rate;
    const voices = s.getVoices();
    if (voices && voices.length){
      const v = voices.find(v=>/female|woman|girl|samantha|amelia|alloy/i.test(v.name)) || voices[0];
      if (v) u.voice = v;
    }
    u.onend = ()=>{ i++; setTimeout(speakNext, 240); };
    s.speak(u);
    // attempt to play CDN audio too if available
    ensureAudioEl();
    audioEl.currentTime = 0;
    audioEl.play().catch(()=>{ /* blocked ‚Äî fine */ });
  }
  speakNext();
}

singBtn.addEventListener('click', ()=>{
  speakHappyBirthday();
  startMelody();
});

/* ---------- Simple WebAudio melody (toggle) ---------- */
const musicBtn = document.getElementById('musicBtn');
musicBtn.addEventListener('click', ()=>{
  if (!melodyOn){ startMelody(); musicBtn.textContent = '‚ô™ Melody: On'; musicBtn.classList.remove('btn-ghost'); }
  else { stopMelody(); musicBtn.textContent = '‚ô™ Melody: Off'; musicBtn.classList.add('btn-ghost'); }
});

function startMelody(){
  if (!window.AudioContext && !window.webkitAudioContext){ alert('WebAudio not supported'); return; }
  audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
  const master = audioCtx.createGain(); master.connect(audioCtx.destination); master.gain.value = 0.12;
  const now = audioCtx.currentTime;
  const melody = [523.25, 523.25, 587.33, 523.25, 698.46, 659.25]; // fragment
  let t = now;
  melody.forEach((freq,i)=>{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.value = 0.0001;
    o.connect(g); g.connect(master);
    o.start(t);
    g.gain.linearRampToValueAtTime(0.14, t+0.01);
    g.gain.linearRampToValueAtTime(0.0001, t+0.45);
    o.stop(t+0.5);
    t += 0.5;
  });
  // gentle pad
  const pad = audioCtx.createOscillator();
  const padGain = audioCtx.createGain();
  pad.type = 'sawtooth'; pad.frequency.value = 220; padGain.gain.value = 0.02;
  pad.connect(padGain); padGain.connect(master);
  pad.start(now); pad.stop(now+6.5);
  melodyOn = true;
  setTimeout(()=>{ melodyOn=false; }, 7000);
}

function stopMelody(){ if (audioCtx && audioCtx.state !== 'closed'){ audioCtx.close(); audioCtx = null; } melodyOn = false; }

/* ---------- Share & download ---------- */
document.getElementById('shareBtn').addEventListener('click', async ()=>{
  const url = location.href;
  if (navigator.share){ try{ await navigator.share({title:'Happy Birthday Emily', text:'Open this for a birthday surprise üéâ', url}); } catch(e){} }
  else {
    try { await navigator.clipboard.writeText(url); alert('Link copied to clipboard ‚Äî share it with Emily ‚ù§Ô∏è'); }
    catch(e){ prompt('Copy this link:', url); }
  }
});
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const html = '<!doctype html>\n' + document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'emily-birthday.html'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('openBtn').addEventListener('click', ()=> window.open(location.href, '_blank'));

/* ---------- Buttons for celebration view ---------- */
document.getElementById('replayBtn').addEventListener('click', triggerCelebration);
document.getElementById('replayCelebrate').addEventListener('click', ()=> { startConfetti(); createSparkles(); playBirthdayAudio(); });
document.getElementById('closeCelebrate').addEventListener('click', ()=> { birthdayScreen.classList.remove('show'); birthdayScreen.setAttribute('aria-hidden','true'); });

/* ---------- If user opens on the target day in KH, auto-trigger (short delay) ---------- */
(function checkIfTodayKH(){
  const khNow2 = nowInKHDate();
  if (khNow2.getFullYear() === targetDate.getUTCFullYear() && khNow2.getMonth() === targetDate.getUTCMonth() && khNow2.getDate() === targetDate.getUTCDate()){
    // It's the target day in Cambodia already ‚Äî celebrate shortly after load
    setTimeout(triggerCelebration, 700);
  }
})();

/* ---------- Accessibility: Enter key sings ---------- */
document.addEventListener('keydown', e=>{ if (e.key === 'Enter') speakHappyBirthday(); });

/* ---------- Optional: Preload a sample image into the wish list (you'll replace SAMPLE_IMAGE_URL) ---------- */
(function addSampleImage(){
  try{
    const img = document.createElement('img');
    img.src = SAMPLE_IMAGE_URL;
    img.alt = 'Emily';
    img.style.maxWidth = '100%';
    img.style.borderRadius = '10px';
    img.style.marginTop = '12px';
    img.style.boxShadow = '0 8px 30px rgba(0,0,0,0.45)';
    document.getElementById('wishList').appendChild(img);
  }catch(e){}
})();
</script>
</body>
</html>
